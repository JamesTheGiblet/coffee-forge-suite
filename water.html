<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterForge - The Solvent Architect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 100%);
            color: #f5e6d3;
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2em;
            color: #4fc3f7;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            color: #81d4fa;
            margin-top: 5px;
        }
        
        .panel {
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #4a3828;
        }
        
        .panel h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .controls {
            display: grid;
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            color: #c9b59a;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #1a1410, #4fc3f7);
            border-radius: 5px;
            outline: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
            border: none;
        }
        
        .value-display {
            color: #4fc3f7;
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }
        
        button {
            background: linear-gradient(135deg, #0277bd, #039be5);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(3, 155, 229, 0.4);
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(3, 155, 229, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .triangle-container {
            width: 100%;
            height: 300px;
            position: relative;
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        .triangle-svg {
            width: 100%;
            height: 100%;
            max-width: 400px;
        }
        
        .triangle {
            fill: rgba(79, 195, 247, 0.1);
            stroke: #4fc3f7;
            stroke-width: 2;
        }
        
        .triangle-vertex {
            font-weight: 600;
            font-size: 14px;
            fill: #c9b59a;
        }
        
        .sweet-spot {
            fill: #ff9800;
            stroke: white;
            stroke-width: 2;
            filter: drop-shadow(0 0 5px rgba(255, 152, 0, 0.5));
        }
        
        .flavor-profile {
            margin-top: 15px;
        }
        
        .flavor-row {
            margin-bottom: 10px;
        }
        
        .flavor-label {
            font-size: 0.9em;
            color: #c9b59a;
            margin-bottom: 5px;
        }
        
        .flavor-indicator {
            height: 10px;
            border-radius: 5px;
            background: rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .flavor-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .fruity-acidic { background: linear-gradient(to right, #ff4081, #f50057); }
        .chocolate-creamy { background: linear-gradient(to right, #8d6e63, #5d4037); }
        .balanced { background: linear-gradient(to right, #4caf50, #2e7d32); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4a3828;
            text-align: center;
        }
        
        .stat-label {
            color: #a8896c;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #4fc3f7;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .export-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4a3828;
            margin-top: 15px;
        }
        
        .export-data {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.8em;
            color: #4fc3f7;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .premium-btn {
            background: linear-gradient(135deg, #0d1b2a, #1a237e);
            border: 1px solid #1565c0;
            color: #90caf9;
            margin-top: 10px;
        }
        .premium-btn:hover {
            border-color: #4fc3f7;
            color: #4fc3f7;
        }

        /* Premium Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 100%);
            margin: 10% auto; 
            padding: 30px; 
            border: 2px solid #d4a574;
            border-radius: 15px;
            width: 90%; 
            max-width: 500px;
            color: #f5e6d3;
            text-align: center;
            box-shadow: 0 0 40px rgba(212, 165, 116, 0.15);
            position: relative;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-modal {
            color: #8a6d4f;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-modal:hover { color: #d4a574; }

        .premium-features { list-style: none; text-align: left; margin: 25px 0; padding: 0 10px; }
        .premium-features li { margin: 12px 0; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        .premium-features i { color: #d4a574; }

        .upgrade-btn {
            background: linear-gradient(135deg, #d4a574, #8b4513);
            color: #2c1810;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }
        .upgrade-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(212, 165, 116, 0.3); }

        /* Mobile Optimization Fixes */
        @media (max-width: 768px) {
            button {
                min-height: 44px; /* iOS minimum */
                font-size: 1rem;
            }
            
            input[type="range"] {
                height: 44px;
                -webkit-tap-highlight-color: transparent;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            /* Scrollable canvas */
            .canvas-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            canvas {
                min-width: 300px;
            }
        }

        /* Prevent zoom on input focus (iOS) */
        input, select, textarea {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíß WaterForge</h1>
            <div class="subtitle">The Solvent Architect</div>
        </header>
        
        <div class="panel">
            <h2>Ionic Composition</h2>
            <div class="controls">
                <div class="control-group">
                    <label>
                        <span><i class="fas fa-atom" style="color: #e53935;"></i> Calcium (Ca¬≤‚Å∫)</span>
                        <span class="value-display" id="calcium-value">40 ppm</span>
                    </label>
                    <input type="range" id="calcium-slider" min="0" max="150" value="40" title="Adjust Calcium (Ca¬≤‚Å∫) concentration in ppm">
                </div>
                <div class="control-group">
                    <label>
                        <span><i class="fas fa-bolt" style="color: #8e24aa;"></i> Magnesium (Mg¬≤‚Å∫)</span>
                        <span class="value-display" id="magnesium-value">40 ppm</span>
                    </label>
                    <input type="range" id="magnesium-slider" min="0" max="100" value="40" title="Adjust Magnesium (Mg¬≤‚Å∫) concentration in ppm">
                </div>
                <div class="control-group">
                    <label>
                        <span><i class="fas fa-balance-scale" style="color: #43a047;"></i> Alkalinity (HCO‚ÇÉ‚Åª)</span>
                        <span class="value-display" id="alkalinity-value">40 ppm</span>
                    </label>
                    <input type="range" id="alkalinity-slider" min="0" max="200" value="40" title="Adjust Alkalinity (HCO‚ÇÉ‚Åª) concentration in ppm">
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>Profile Visualization</h2>
            <div class="triangle-container">
                <svg class="triangle-svg" viewBox="0 0 500 400">
                    <polygon class="triangle" points="250,50 450,350 50,350"/>
                    <text x="250" y="30" text-anchor="middle" class="triangle-vertex">HARDNESS</text>
                    <text x="40" y="370" text-anchor="start" class="triangle-vertex">ALKALINITY</text>
                    <text x="460" y="370" text-anchor="end" class="triangle-vertex">PURITY</text>
                    <circle class="sweet-spot" cx="250" cy="200" r="10" id="sweet-spot"/>
                </svg>
            </div>
        </div>
        
        <div class="panel">
            <h2>Flavor Potential</h2>
            <div class="flavor-profile">
                <div class="flavor-row">
                    <div class="flavor-label">Fruity & Acidic (Mg¬≤‚Å∫ driven)</div>
                    <div class="flavor-indicator"><div class="flavor-fill fruity-acidic" id="fruity-bar" style="width: 50%"></div></div>
                </div>
                <div class="flavor-row">
                    <div class="flavor-label">Chocolate & Creamy (Ca¬≤‚Å∫ driven)</div>
                    <div class="flavor-indicator"><div class="flavor-fill chocolate-creamy" id="chocolate-bar" style="width: 50%"></div></div>
                </div>
                <div class="flavor-row">
                    <div class="flavor-label">Balance</div>
                    <div class="flavor-indicator"><div class="flavor-fill balanced" id="balance-bar" style="width: 80%"></div></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Chemistry Metrics</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Total Hardness</div>
                    <div class="stat-value" id="total-hardness">80 ppm</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Extraction Index</div>
                    <div class="stat-value" id="extraction-index">1.0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">LSI (Scale)</div>
                    <div class="stat-value" id="lsi-value">-0.5</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Buffer Capacity</div>
                    <div class="stat-value" id="buffer-capacity">Medium</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Export to Pipeline</h2>
            <div class="profile-manager" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="openSaveDialog()" style="width: 100%;">üíæ Save Profile</button>
                <button onclick="openLoadDialog()" style="width: 100%;">üìÇ Load Profile</button>
            </div>
            <button id="export-btn">Load Water Profile</button>
            <button class="premium-btn" onclick="showPremiumModal()"><i class="fas fa-lock"></i> Export Lab Report</button>
            <div class="export-box">
                <div class="export-data" id="export-status">Ready to sync...</div>
            </div>
        </div>

        <!-- Premium Modal -->
        <div id="premiumModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closePremiumModal()">&times;</span>
                <h2 style="color: #d4a574; margin-bottom: 10px;"><i class="fas fa-crown"></i> Go Premium</h2>
                <p style="color: #a8896c;">Unlock advanced water chemistry tools.</p>
                <ul class="premium-features">
                    <li><i class="fas fa-check-circle"></i> Professional Water Chemistry Reports</li>
                    <li><i class="fas fa-check-circle"></i> Save Multiple Water Profiles</li>
                    <li><i class="fas fa-check-circle"></i> Advanced Buffer Capacity Stats</li>
                </ul>
                <button class="upgrade-btn" onclick="closePremiumModal()">Unlock Now - $4.99</button>
            </div>
        </div>

        <!-- Save Modal -->
        <div id="saveModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-modal" onclick="closeSaveDialog()">&times;</span>
                <h2 style="color: #d4a574;">Save Water Profile</h2>
                <input type="text" id="profileName" placeholder="Profile name (e.g., 'SCAA Standard')" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #4a3828; background: rgba(0,0,0,0.3); color: #f5e6d3;">
                <button onclick="saveCurrentProfile()">Save</button>
                <div id="saveStatus" style="margin-top: 10px; color: #d4a574;"></div>
            </div>
        </div>

        <!-- Load Modal -->
        <div id="loadModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-modal" onclick="closeLoadDialog()">&times;</span>
                <h2 style="color: #d4a574;">Load Water Profile</h2>
                <div id="profileList" style="margin-top: 15px; text-align: left;"></div>
            </div>
        </div>
    </div>

    <script>
        const waterModel = {
            calcium: 40,
            magnesium: 40,
            alkalinity: 40,
            
            get hardness() { return Math.round((2.497 * this.calcium) + (4.118 * this.magnesium)); },
            
            calculateExtractionIndex() { 
                return ((this.magnesium * 1.5) / (this.calcium * 0.8 || 1)).toFixed(2); 
            },
            
            calculateBufferCapacity() { 
                return this.alkalinity < 20 ? "Low" : this.alkalinity < 60 ? "Medium" : "High"; 
            },
            
            calculateLSI() { 
                // Simplified Langelier Saturation Index approximation
                const tds = this.calcium + this.magnesium + this.alkalinity + 20;
                return ((this.calcium + this.magnesium) / 100 + this.alkalinity / 100 - tds / 200 - 0.5).toFixed(2); 
            },
            
            calculateProfileSummary() {
                const ex = parseFloat(this.calculateExtractionIndex());
                return ex > 1.5 ? "Bright & Fruity" : ex > 0.8 ? "Balanced" : "Heavy Body";
            }
        };

        const els = {
            ca: document.getElementById('calcium-slider'),
            mg: document.getElementById('magnesium-slider'),
            alk: document.getElementById('alkalinity-slider'),
            caVal: document.getElementById('calcium-value'),
            mgVal: document.getElementById('magnesium-value'),
            alkVal: document.getElementById('alkalinity-value'),
            hardness: document.getElementById('total-hardness'),
            extIndex: document.getElementById('extraction-index'),
            lsi: document.getElementById('lsi-value'),
            buffer: document.getElementById('buffer-capacity'),
            sweetSpot: document.getElementById('sweet-spot'),
            fruityBar: document.getElementById('fruity-bar'),
            chocBar: document.getElementById('chocolate-bar'),
            balBar: document.getElementById('balance-bar'),
            exportBtn: document.getElementById('export-btn'),
            exportStatus: document.getElementById('export-status')
        };

        function updateUI() {
            // Update model
            waterModel.calcium = parseInt(els.ca.value);
            waterModel.magnesium = parseInt(els.mg.value);
            waterModel.alkalinity = parseInt(els.alk.value);

            // Update text
            els.caVal.textContent = waterModel.calcium + ' ppm';
            els.mgVal.textContent = waterModel.magnesium + ' ppm';
            els.alkVal.textContent = waterModel.alkalinity + ' ppm';
            
            els.hardness.textContent = waterModel.hardness + ' ppm';
            els.extIndex.textContent = waterModel.calculateExtractionIndex();
            els.lsi.textContent = waterModel.calculateLSI();
            els.buffer.textContent = waterModel.calculateBufferCapacity();

            // Update Visuals
            const totalIons = waterModel.calcium + waterModel.magnesium + 1;
            const mgRatio = waterModel.magnesium / totalIons;
            const caRatio = waterModel.calcium / totalIons;
            
            els.fruityBar.style.width = (mgRatio * 100) + '%';
            els.chocBar.style.width = (caRatio * 100) + '%';
            
            // Balance bar logic
            const balance = 100 - Math.abs(50 - (mgRatio * 100)) * 2;
            els.balBar.style.width = balance + '%';

            // Triangle Position (Simplified barycentric-ish mapping)
            // Top: Hardness (Ca+Mg), Left: Alkalinity, Right: Purity (Low TDS)
            // We map Hardness to Y (up), Alkalinity to X (left)
            
            const hNorm = Math.min(1, waterModel.hardness / 300);
            const aNorm = Math.min(1, waterModel.alkalinity / 200);
            
            // Center is 250, 200 roughly
            // High hardness -> moves up (y decreases)
            // High alkalinity -> moves left (x decreases)
            
            const x = 400 - (aNorm * 300) - (hNorm * 50); 
            const y = 350 - (hNorm * 300);
            
            // Clamp to triangle roughly
            els.sweetSpot.setAttribute('cx', Math.max(50, Math.min(450, x)));
            els.sweetSpot.setAttribute('cy', Math.max(50, Math.min(350, y)));
        }

        // Event Listeners
        [els.ca, els.mg, els.alk].forEach(el => el.addEventListener('input', updateUI));

        els.exportBtn.addEventListener('click', () => {
            const data = {
                waterProfile: {
                    calcium: waterModel.calcium + ' ppm',
                    magnesium: waterModel.magnesium + ' ppm',
                    alkalinity: waterModel.alkalinity + ' ppm',
                    totalHardness: waterModel.hardness + ' ppm'
                },
                metrics: {
                    extractionIndex: waterModel.calculateExtractionIndex(),
                    bufferCapacity: waterModel.calculateBufferCapacity(),
                    lsi: waterModel.calculateLSI(),
                    flavorTarget: waterModel.calculateProfileSummary()
                }
            };
            
            window.parent.postMessage({
                type: 'FORGE_EXPORT',
                module: 'WATER',
                payload: data
            }, '*');
            
            els.exportStatus.textContent = JSON.stringify(data, null, 2);
        });

        // Pipeline Listener
        window.addEventListener('message', (event) => {
            if (event.data.type === 'FORGE_PIPELINE_UPDATE' && event.data.module === 'ROAST') {
                const roast = event.data.payload;
                const level = roast.roastProfile.level;
                
                // Auto-adjust based on roast level for optimal extraction
                if (level === 'Light') {
                    // Light: High Mg for fruit extraction, Low Alk to preserve acidity
                    els.mg.value = 75; els.ca.value = 25; els.alk.value = 30;
                } else if (level === 'Medium') {
                    // Medium: Balanced profile
                    els.mg.value = 50; els.ca.value = 40; els.alk.value = 45;
                } else if (level === 'Medium-Dark') {
                    // Med-Dark: Shift towards body (Ca) and buffering
                    els.mg.value = 35; els.ca.value = 55; els.alk.value = 60;
                } else { // Dark
                    // Dark: High Ca for body, High Alk to buffer bitterness
                    els.mg.value = 20; els.ca.value = 70; els.alk.value = 80;
                }
                updateUI();
                els.exportStatus.textContent = `Received Roast Data: ${level} Roast.\nWater profile optimized for this roast level.`;
            }
            
            if (event.data.type === 'FORGE_SYNC_REQUEST') {
                // Re-broadcast current state if requested
                els.exportBtn.click();
            }
        });

        // --- Modal Logic ---
        function showPremiumModal() {
            document.getElementById('premiumModal').style.display = 'block';
        }
        function closePremiumModal() {
            document.getElementById('premiumModal').style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == document.getElementById('premiumModal')) closePremiumModal();
        }
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') closePremiumModal();
        });

        // Init
        updateUI();
    </script>
    <script src="analytics.js"></script>
</body>
</html>
